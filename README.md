# AI Image Generator (React + Supabase + Clerk)

This project is a web application built with React that allows users to generate AI images based on various predefined prompt templates and user inputs. It leverages Supabase for backend services (database, authentication integration, storage, edge functions) and Clerk for user authentication.

## Features

*   **Multiple Generator Templates:** Provides different image generation styles (e.g., Barbie Style Box, Action Figure, Packaging Mockup).
*   **Dynamic Prompt Generation:** Uses templates stored in Supabase and fills them with user inputs.
*   **Reference Image Upload:** Allows users to upload reference images for the generation process (handled by the Edge Function).
*   **Admin Settings:**
    *   Edit and save prompt templates directly to the Supabase database.
    *   Upload and manage a global logo image stored in Supabase Storage and referenced in the database.
*   **User Authentication:** Uses Clerk for user signup, login, and session management.
*   **Supabase Integration:**
    *   **Database:** Stores prompt templates, application settings (like logo URL).
    *   **Auth:** Integrates with Clerk - JWTs generated by Clerk are used to authenticate Supabase requests. RLS policies control data access based on user roles defined in Clerk metadata.
    *   **Storage:** Stores uploaded logo images and potentially generated images (depending on Edge Function implementation).
    *   **Edge Functions:** Handles the core AI image generation logic (`generate-image` function), receiving prompts, parameters, and reference images.

## Tech Stack

*   **Frontend:** React, Vite, TypeScript, CSS
*   **Routing:** React Router DOM
*   **Authentication:** Clerk (@clerk/clerk-react)
*   **Backend:** Supabase
    *   Database (Postgres)
    *   Storage
    *   Edge Functions (Deno)
    *   Auth Helpers (@supabase/supabase-js)
*   **Linting/Formatting:** ESLint, TypeScript ESLint

## Project Structure

```
.
├── image-generator-react/ # Main React application source code
│   ├── public/
│   │   └── logo.png
│   ├── src/
│   │   ├── components/    # React components (Generators, Admin, Header, etc.)
│   │   ├── assets/        # Static assets (if any)
│   │   ├── App.tsx        # Main application component with routing
│   │   ├── main.tsx       # Application entry point
│   │   ├── index.css      # Global styles
│   │   └── style.css      # Component-specific styles (consider organizing better)
│   │   └── supabaseClient.ts # Supabase client initialization
│   ├── index.html
│   ├── package.json       # Frontend dependencies and scripts
│   ├── tsconfig.json
│   ├── tsconfig.node.json
│   └── vite.config.ts
├── supabase/                # Supabase backend configuration
│   ├── functions/
│   │   └── generate-image/  # Source code for the Edge Function
│   │       └── index.ts
│   └── config.toml        # Supabase project config (ports, etc.)
│   └── migrations/        # Database schema migrations
│   └── seed.sql           # Initial database seed data (optional)
├── .env.local               # Local environment variables (!!! IMPORTANT - DO NOT COMMIT !!!)
├── .gitignore
├── README.md                # This file
└── package.json             # Root dependencies (e.g., Supabase CLI)
```

## Setup and Running

1.  **Prerequisites:**
    *   Node.js (LTS version recommended)
    *   npm or yarn
    *   Supabase CLI (`npm install -g supabase`)
    *   Clerk Account (for authentication keys)
    *   Supabase Account (for backend project)

2.  **Clone the repository:**
    ```bash
    git clone <your-repo-url>
    cd <your-repo-directory>
    ```

3.  **Install Dependencies:**
    *   Install root dependencies:
        ```bash
        npm install 
        # or yarn install
        ```
    *   Install frontend dependencies:
        ```bash
        cd image-generator-react
        npm install
        # or yarn install
        cd .. 
        ```

4.  **Supabase Setup:**
    *   Link the local project to your Supabase project:
        ```bash
        supabase login
        supabase link --project-ref <your-project-ref>
        supabase start # (Optional, if running local Supabase instance)
        ```
    *   Apply database migrations:
        ```bash
        supabase db push # (If using remote Supabase)
        # or supabase migration up (If running local instance)
        ```
    *   Deploy Edge Functions:
        ```bash
        supabase functions deploy --project-ref <your-project-ref>
        ```

5.  **Clerk Setup:**
    *   Create a Clerk application in your Clerk dashboard.
    *   Configure Supabase integration in Clerk settings, ensuring you create a JWT template that includes the necessary user metadata (like `role`) under the `user_metadata` claim, matching the RLS policies. Example template:
      ```json
      {
        "aud": "authenticated",
        "role": "authenticated",
        "email": "{{user.primary_email_address}}",
        "app_metadata": {},
        "user_metadata": {
          "role": "{{user.public_metadata.role}}" 
        }
      }
      ```
    *   Ensure users intended to be administrators have the `role` key set to `"admin"` in their **Public Metadata** within the Clerk dashboard.

6.  **Environment Variables:**
    *   Create a `.env.local` file in the `image-generator-react` directory.
    *   Add your Supabase URL and Anon Key, and your Clerk Publishable Key:
        ```plaintext
        # image-generator-react/.env.local

        VITE_SUPABASE_URL=https://<your-project-ref>.supabase.co
        VITE_SUPABASE_ANON_KEY=<your-supabase-anon-key>
        VITE_CLERK_PUBLISHABLE_KEY=<your-clerk-pk-key> 
        ```
    *   **IMPORTANT:** Add `.env.local` to your `.gitignore` file if it's not already there. Do not commit sensitive keys.

7.  **Run the Development Server:**
    ```bash
    cd image-generator-react
    npm run dev
    # or yarn dev
    ```
    The application should now be running, typically on `http://localhost:5173`.

## Key Components

*   **`AdminSettings.tsx`:** Allows users with the 'admin' role (defined in Clerk metadata) to manage prompt templates and the application logo.
*   **`BarbieStyleBoxGenerator.tsx` / `ActionFigureGenerator.tsx` / etc.:** Components providing UI forms for specific image generation tasks, constructing prompts, and calling the `generate-image` Edge Function.
*   **`Header.tsx`:** Displays navigation and user authentication status (via Clerk components).
*   **`supabaseClient.ts`:** Initializes and exports the Supabase client instance.
*   **`App.tsx`:** Sets up routing using `react-router-dom`.

## Backend Details

*   **`prompt_templates` Table:** Stores the templates used by the generators (`template_id`, `template_text`). RLS policy ensures only admins can update.
*   **`settings` Table:** Stores global settings, currently used for the `logo_url`. RLS policy ensures only admins can update.
*   **Storage (`app-assets` Bucket):** Stores the `public/logo.png` file. RLS policy allows admins to upload/update.
*   **`generate-image` Edge Function:** Takes prompt, parameters (size, quality), and optional reference images. Interacts with an AI image generation API (details depend on function implementation) and likely returns the URL of the generated image. Requires an authenticated user token.

## Troubleshooting / Known Fixes

*   **Admin Template Saving Fails (RLS Block):**
    *   **Symptom:** Clicking "Save Changes" for a template in Admin Settings results in console logs showing `Error: null` but `Data: []` from the Supabase update call, indicating an RLS block despite the user having the correct role in Clerk metadata and the RLS policy checking that metadata.
    *   **Cause:** Potential issues with the shared Supabase client instance (`supabase` from `supabaseClient.ts`) not reliably using the latest authenticated token containing the necessary Clerk metadata for direct `.update()` calls.
    *   **Fix Implemented (in `AdminSettings.tsx` -> `handleSaveTemplate`):** Instead of using the shared `supabase` client for the update, the function now explicitly fetches the fresh `accessToken` from Clerk using `getToken({ template: 'supabase' })` and creates a *temporary, short-lived* authenticated Supabase client instance specifically for the `.update().eq().select()` operation. This ensures the request uses the correct token, bypassing potential state issues with the shared client. See the `handleSaveTemplate` function for the implementation using `createClient`.
    *   **Verification:** Ensure the Clerk JWT template for Supabase correctly includes `user_metadata.role` and the user's Public Metadata in Clerk has `role: "admin"`.


</rewritten_file> 